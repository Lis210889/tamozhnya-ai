/**
 * База знаний с примерами классификации товаров
 * Можно расширять, добавляя новые примеры для обучения ИИ
 */

export interface ClassificationExample {
  description: string; // Описание товара из документа
  correctCode: string; // Правильный код ТН ВЭД
  reasoning: string; // Обоснование классификации
  rule: string; // Примененное правило интерпретации
  commonMistakes: string[]; // Типичные ошибки при классификации
  category: string; // Категория товара
}

export const classificationExamples: ClassificationExample[] = [
  {
    description: "Смартфон Apple iPhone 15 Pro, 256 ГБ, титановый корпус, с зарядным устройством в комплекте",
    correctCode: "8517 12 000 0",
    reasoning: "Основная функция - телефонная связь. Материал корпуса и объем памяти не влияют на классификацию. Зарядное устройство - аксессуар, не влияет на классификацию основного товара.",
    rule: "Правило 3б - классификация по основной функции",
    commonMistakes: [
      "Классификация по материалу корпуса (титан)",
      "Учет зарядного устройства как комплекта",
      "Классификация по объему памяти"
    ],
    category: "Электроника и телекоммуникация"
  },
  {
    description: "Комплект постельного белья: простынь 220x240 см, пододеяльник 200x220 см, 2 наволочки 70x70 см, 100% хлопок, для розничной продажи",
    correctCode: "6302 31 000 0",
    reasoning: "Комплект для розничной продажи классифицируется как единое целое. Основной материал - хлопок. Все компоненты из одного материала.",
    rule: "Правило 3б - комплект классифицируется по основному компоненту",
    commonMistakes: [
      "Классификация каждого предмета отдельно",
      "Классификация по размеру вместо материала",
      "Игнорирование того, что это комплект для розничной продажи"
    ],
    category: "Текстиль и изделия из текстиля"
  },
  {
    description: "Детская игрушка: плюшевый медведь, высота 30 см, с встроенным музыкальным механизмом, батарейки в комплекте",
    correctCode: "9503 00 190 0",
    reasoning: "Основная функция - игрушка. Музыкальный механизм - дополнительная функция, не меняет классификацию. Батарейки - расходный материал.",
    rule: "Правило 3а - наиболее специфическое описание (игрушка)",
    commonMistakes: [
      "Классификация как музыкальный инструмент",
      "Классификация по материалу (плюш) в раздел текстиля",
      "Учет батареек как комплекта"
    ],
    category: "Игрушки и игры"
  },
  {
    description: "Кофе молотый, жареный, в зернах, 100% арабика, упакован в вакуумные пакеты по 1 кг, для розничной продажи",
    correctCode: "0901 11 000 0",
    reasoning: "Кофе жареный в зернах. Способ упаковки не влияет на классификацию. Для розничной продажи - не влияет.",
    rule: "Правило 1 - конкретное описание товара",
    commonMistakes: [
      "Классификация как молотый кофе (если не указано)",
      "Классификация по упаковке",
      "Путаница между жареным и нежареным кофе"
    ],
    category: "Пищевые продукты"
  },
  {
    description: "Мебель: письменный стол из массива дуба, размеры 120x60x75 см, с выдвижными ящиками, без стула",
    correctCode: "9403 30 000 0",
    reasoning: "Мебель для офисов - письменные столы. Материал (дуб) не влияет на классификацию мебели. Наличие ящиков - неотъемлемая часть стола.",
    rule: "Правило 1 - конкретное описание (письменный стол)",
    commonMistakes: [
      "Классификация по материалу (древесина) в раздел лесоматериалов",
      "Классификация как комплект мебели",
      "Путаница между офисной и домашней мебелью"
    ],
    category: "Мебель"
  },
  {
    description: "Одежда: мужская куртка зимняя, утепленная пухом, верх из полиэстера, подкладка из полиэстера, размер L",
    correctCode: "6201 93 000 0",
    reasoning: "Мужская верхняя одежда. Материал верха - синтетические волокна (полиэстер). Утеплитель (пух) не влияет на классификацию по материалу верха.",
    rule: "Правило 1 - классификация по материалу верха",
    commonMistakes: [
      "Классификация по утеплителю (пух)",
      "Классификация по подкладке",
      "Путаница между мужской и женской одеждой"
    ],
    category: "Одежда и текстильные изделия"
  },
  {
    description: "Автомобиль легковой, бензиновый двигатель, объем двигателя 1.6 л, мощность 120 л.с., 5 мест, новый",
    correctCode: "8703 23 190 9",
    reasoning: "Легковой автомобиль с двигателем внутреннего сгорания. Объем двигателя 1500-3000 см³. Мощность и количество мест учитываются для точной классификации.",
    rule: "Правило 1 - конкретное описание с техническими характеристиками",
    commonMistakes: [
      "Неправильное определение объема двигателя",
      "Путаница между легковыми и грузовыми автомобилями",
      "Игнорирование мощности двигателя"
    ],
    category: "Транспортные средства"
  },
  {
    description: "Лекарственное средство: таблетки парацетамол 500 мг, упаковка 20 таблеток, для лечения боли и жара",
    correctCode: "3004 90 000 0",
    reasoning: "Лекарственное средство в дозированной форме (таблетки). Действующее вещество и дозировка указаны. Упаковка не влияет на классификацию.",
    rule: "Правило 1 - лекарственные средства в дозированной форме",
    commonMistakes: [
      "Классификация по действующему веществу отдельно",
      "Классификация по упаковке",
      "Путаница между лекарствами и БАДами"
    ],
    category: "Фармацевтическая продукция"
  }
];

/**
 * Получить примеры для конкретной категории товаров
 */
export function getExamplesByCategory(category: string): ClassificationExample[] {
  return classificationExamples.filter(ex => 
    ex.category.toLowerCase().includes(category.toLowerCase())
  );
}

/**
 * Получить примеры, похожие на описание товара
 */
export function getSimilarExamples(description: string, limit: number = 3): ClassificationExample[] {
  const keywords = description.toLowerCase().split(/\s+/);
  
  return classificationExamples
    .map(ex => ({
      ...ex,
      score: keywords.reduce((score, keyword) => {
        if (ex.description.toLowerCase().includes(keyword)) {
          return score + 1;
        }
        if (ex.category.toLowerCase().includes(keyword)) {
          return score + 0.5;
        }
        return score;
      }, 0)
    }))
    .filter(ex => ex.score > 0)
    .sort((a, b) => b.score - a.score)
    .slice(0, limit)
    .map(({ score, ...ex }) => ex);
}

/**
 * Форматировать примеры для включения в промпт
 */
export function formatExamplesForPrompt(examples: ClassificationExample[]): string {
  if (examples.length === 0) return '';
  
  let prompt = '\n\n**ПРИМЕРЫ КЛАССИФИКАЦИИ (для справки):**\n\n';
  
  examples.forEach((ex, index) => {
    prompt += `Пример ${index + 1}:\n`;
    prompt += `Товар: "${ex.description}"\n`;
    prompt += `Правильный код: ${ex.correctCode}\n`;
    prompt += `Обоснование: ${ex.reasoning}\n`;
    prompt += `Примененное правило: ${ex.rule}\n`;
    prompt += `Типичные ошибки: ${ex.commonMistakes.join(', ')}\n\n`;
  });
  
  return prompt;
}
